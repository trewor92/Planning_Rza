import React, { Component } from 'react';
import {connect} from 'react-redux'
import {getTableHeader, getTableData, getTableName, getTableError, getPath} from 'selectors'
import * as R from 'ramda'
import {withRouter} from 'react-router'
import {fetchDataToTable} from 'actions'
import {compose} from 'redux'
import './table.css'

class Table extends Component {
  componentDidMount()
  {
    this.updateTableData()
  }

  updateTableData()
  {
    const path = this.props.path
    this.props.fetchDataToTable(this.props.path)
  }

  getKeys = ()=>{
    const {data}=this.props
    if(data)
    {
      const firstElement = R.head(data)
      const keys = Object.keys(firstElement)
      return keys;
    }
    else {
      return []
    }
  }

  getHeader = (error)=>{
    if(error) return null
    const headers = this.props.headers
    const keys = this.getKeys()
    const getName = (key)=>R.prop(key,headers)?R.prop(key,headers):key
    return <tr>{keys.map((key, index)=>{return <th key={key}>{getName(key)}</th>
  })}</tr>
  }

  renderRow = (rowData) =>{
    const keys = this.getKeys();
    return keys.map((key, index)=>{return <td key={key}>{R.prop(key,rowData)}</td>})
  }

  renderRows = (error)=>{
    if(error) return null
    const data = this.props.data;
    return data?.map((row, index)=>{
    return <tr key={index}>{this.renderRow(row)}</tr>})
  }

  renderCaption = (error)=>{
    return <caption className={`text-center font-weight-bold ${error?'text-danger':''}`}>{error?'Ошибка!':this.props.name}</caption>
  }

  render() {
    return(
      <table className="table top">
          {this.renderCaption(this.props.error)}
        <thead>
        {
          this.getHeader(this.props.error)
        }
        </thead>
        <tbody>
        {
          this.renderRows(this.props.error)
        }
        </tbody>
      </table>
    )
  }
}

const mapDispatchProps={
  fetchDataToTable
}

const mapStateToProps = (state) => {
  return{
  headers: getTableHeader(state),
  data: getTableData(state),
  name: getTableName(state),
  error: getTableError(state),
  path: getPath(state)
  }
}

export default connect(mapStateToProps,mapDispatchProps)(Table)
